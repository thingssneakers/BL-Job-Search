<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Resume Reviewer - BL Job Search</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f0f2f5;color:#1e293b;line-height:1.6}

/* Login */
.login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#1e3a5f 0%,#2563eb 50%,#3b82f6 100%)}
.login-box{background:#fff;border-radius:16px;padding:48px 40px;box-shadow:0 20px 60px rgba(0,0,0,.2);text-align:center;width:100%;max-width:380px;margin:20px}
.login-box h1{font-size:1.6rem;font-weight:700;margin-bottom:6px}
.login-box p{color:#64748b;font-size:.875rem;margin-bottom:28px}
.login-input{width:100%;padding:12px 16px;border:2px solid #e2e8f0;border-radius:8px;font-size:.95rem;outline:none;margin-bottom:16px}
.login-input:focus{border-color:#2563eb}
.login-btn{width:100%;padding:12px;background:#2563eb;color:#fff;border:none;border-radius:8px;font-size:.95rem;font-weight:600;cursor:pointer}
.login-btn:hover{background:#1d4ed8}
.login-error{color:#dc2626;font-size:.8rem;margin-top:8px;min-height:20px}

/* App */
.app{display:none}
.header{background:linear-gradient(135deg,#1e3a5f 0%,#2563eb 100%);color:#fff;padding:20px 0;position:sticky;top:0;z-index:100;box-shadow:0 2px 12px rgba(0,0,0,.15)}
.header-inner{max-width:1100px;margin:0 auto;padding:0 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
.header h1{font-size:1.25rem;font-weight:700}
.header-actions{display:flex;gap:8px}
.hdr-btn{background:rgba(255,255,255,.15);color:#fff;border:1px solid rgba(255,255,255,.25);padding:6px 14px;border-radius:6px;font-size:.75rem;cursor:pointer;text-decoration:none}
.hdr-btn:hover{background:rgba(255,255,255,.25)}

.container{max-width:1100px;margin:24px auto;padding:0 24px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:24px}
@media(max-width:900px){.grid{grid-template-columns:1fr}}

.card{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:24px;margin-bottom:24px}
.card h2{font-size:1.05rem;font-weight:700;margin-bottom:16px}

/* Job info bar */
.job-bar{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:14px 16px;margin-bottom:16px}
.job-bar .jt{font-weight:700;font-size:1rem}
.job-bar .jc{color:#2563eb;font-weight:600;font-size:.85rem}
.job-bar .jm{color:#64748b;font-size:.78rem;margin-top:2px}
.job-bar a{color:#2563eb;font-size:.8rem}

/* Form */
label{display:block;font-size:.82rem;font-weight:600;color:#475569;margin-bottom:6px}
select,textarea{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:8px;font-size:.85rem;outline:none;font-family:inherit}
select:focus,textarea:focus{border-color:#2563eb;box-shadow:0 0 0 3px rgba(37,99,235,.1)}
textarea{resize:vertical}

/* File input - native, fully visible */
.file-input-wrap{margin-bottom:16px}
.file-input-wrap input[type="file"]{display:block;width:100%;padding:12px;border:2px dashed #d1d5db;border-radius:8px;font-size:.85rem;cursor:pointer;background:#fafbfc}
.file-input-wrap input[type="file"]:hover{border-color:#2563eb;background:#eff6ff}
.file-status{margin-top:8px;font-size:.82rem;padding:8px 12px;border-radius:6px;display:none}
.file-status.ok{display:block;background:#f0fdf4;border:1px solid #bbf7d0;color:#166534}
.file-status.err{display:block;background:#fef2f2;border:1px solid #fecaca;color:#dc2626}
.file-status.loading{display:flex;align-items:center;gap:8px;background:#eff6ff;border:1px solid #bfdbfe;color:#1e40af}

/* Buttons */
.btn{padding:12px 24px;border:none;border-radius:8px;font-size:.95rem;font-weight:600;cursor:pointer;width:100%;transition:all .15s}
.btn:disabled{opacity:.5;cursor:not-allowed}
.btn-blue{background:#2563eb;color:#fff}
.btn-blue:hover:not(:disabled){background:#1d4ed8}
.btn-green{background:#16a34a;color:#fff}
.btn-green:hover:not(:disabled){background:#15803d}
.btn-outline{background:#fff;color:#475569;border:1px solid #d1d5db;font-size:.82rem;padding:8px 16px;width:auto}
.btn-outline:hover{background:#f8fafc}

/* API key */
.api-section{background:#fffbeb;border:1px solid #fde68a;border-radius:8px;padding:14px 16px;margin-bottom:16px}
.api-section label{color:#92400e;margin-bottom:4px}
.api-section input{width:100%;padding:8px 12px;border:1px solid #fde68a;border-radius:6px;font-size:.82rem;font-family:monospace;outline:none}
.api-section .hint{font-size:.72rem;color:#a16207;margin-top:4px}

/* Progress */
.progress{display:none;align-items:center;gap:10px;padding:12px 16px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;margin:16px 0;font-size:.85rem;color:#1e40af;font-weight:500}
.progress.show{display:flex}
.spin{width:18px;height:18px;border:3px solid #bfdbfe;border-top-color:#2563eb;border-radius:50%;animation:sp .8s linear infinite;flex-shrink:0}
@keyframes sp{to{transform:rotate(360deg)}}

/* Error */
.err-box{display:none;padding:12px 16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;color:#dc2626;font-size:.85rem;margin:12px 0}
.err-box.show{display:block}

/* Suggestions */
.sug-counter{display:none;padding:12px 16px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;margin-bottom:16px;font-size:.85rem;font-weight:600;color:#166534}
.sug-counter.show{display:block}
.sug-section{margin-bottom:20px}
.sug-section h3{font-size:.9rem;font-weight:700;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid #e2e8f0}
.sug-card{background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:16px;margin-bottom:12px}
.sug-card.accepted{border-color:#16a34a;background:#f0fdf4}
.sug-card.skipped{opacity:.5}
.sug-lbl{font-size:.7rem;text-transform:uppercase;letter-spacing:.05em;font-weight:700;margin-bottom:4px}
.sug-orig{background:#f1f5f9;border-left:3px solid #94a3b8;padding:10px 14px;border-radius:0 6px 6px 0;font-size:.82rem;color:#475569;margin-bottom:8px;line-height:1.5}
.sug-new{background:#dcfce7;border-left:3px solid #16a34a;padding:10px 14px;border-radius:0 6px 6px 0;font-size:.82rem;color:#166534;margin-bottom:8px;line-height:1.5}
.sug-why{font-size:.78rem;color:#64748b;margin-bottom:10px;font-style:italic}
.sug-btns{display:flex;gap:8px}
.sb-accept{background:#16a34a;color:#fff;border:none;padding:6px 16px;border-radius:6px;font-size:.78rem;font-weight:600;cursor:pointer}
.sb-accept:hover{background:#15803d}
.sb-accept.on{background:#bbf7d0;color:#166534}
.sb-skip{background:#f1f5f9;color:#64748b;border:1px solid #d1d5db;padding:6px 16px;border-radius:6px;font-size:.78rem;font-weight:600;cursor:pointer}
.sb-skip:hover{background:#e2e8f0}

.dl-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}

.empty-state{text-align:center;padding:48px 20px;color:#94a3b8}
.empty-state .icon{font-size:3rem;margin-bottom:12px}
.empty-state p{font-size:.9rem}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <h1>Resume Reviewer</h1>
    <p>Enter password to access</p>
    <input type="password" class="login-input" id="pw" placeholder="Password" autocomplete="off">
    <button class="login-btn" id="loginBtn">Login</button>
    <div class="login-error" id="loginErr"></div>
  </div>
</div>

<!-- APP -->
<div class="app" id="app">
  <div class="header">
    <div class="header-inner">
      <h1>Resume Reviewer</h1>
      <div class="header-actions">
        <a href="jobs.html" class="hdr-btn">Back to Dashboard</a>
        <button class="hdr-btn" id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <!-- LEFT -->
      <div>
        <!-- Job selection -->
        <div class="card">
          <h2>Job You're Applying For</h2>
          <div class="job-bar" id="jobBar" style="display:none">
            <div class="jt" id="jTitle"></div>
            <div class="jc" id="jCompany"></div>
            <div class="jm" id="jMeta"></div>
            <a id="jLink" href="#" target="_blank" style="display:none">View Job Posting</a>
          </div>
          <label for="jobSelect">Select a job from your dashboard:</label>
          <select id="jobSelect"><option value="">-- Select a job --</option></select>
          <div style="margin-top:16px">
            <label for="jobDesc">Paste full job description:</label>
            <textarea id="jobDesc" rows="6" placeholder="Paste the full job description here for the most accurate analysis..."></textarea>
          </div>
        </div>

        <!-- Resume upload -->
        <div class="card">
          <h2>Your Resume</h2>
          <div class="file-input-wrap">
            <label for="resumeFile">Upload resume file (PDF or DOCX):</label>
            <input type="file" id="resumeFile" accept=".pdf,.docx">
            <div class="file-status" id="fileStatus"></div>
          </div>
          <label for="resumeText">Or paste your resume text here:</label>
          <textarea id="resumeText" rows="10" placeholder="If the file upload doesn't work, paste your full resume text here instead."></textarea>
        </div>

        <!-- API key -->
        <div class="card">
          <h2>Claude API Key</h2>
          <div class="api-section">
            <label for="apiKey">Your Anthropic API Key</label>
            <input type="password" id="apiKey" placeholder="sk-ant-api03-...">
            <div class="hint">Stored locally, only sent to the Anthropic API. Get one at console.anthropic.com</div>
          </div>
        </div>

        <button class="btn btn-blue" id="analyzeBtn" disabled>Analyze Resume Against Job</button>
        <div class="progress" id="prog">
          <div class="spin"></div>
          <span id="progText">Analyzing your resume...</span>
        </div>
        <div class="err-box" id="analysisErr"></div>
      </div>

      <!-- RIGHT -->
      <div>
        <div class="sug-counter" id="sugCount"></div>
        <div id="resultsWrap" style="display:none">
          <div class="card">
            <h2>Suggested Improvements</h2>
            <div id="sugBody"></div>
          </div>
          <div class="dl-row" id="dlRow" style="display:none">
            <button class="btn btn-green" id="genBtn">Generate Updated Resume</button>
            <button class="btn-outline" id="dlTxt">Download .txt</button>
            <button class="btn-outline" id="copyBtn">Copy to Clipboard</button>
          </div>
        </div>
        <div class="card" id="emptyState">
          <div class="empty-state">
            <div class="icon">&#128270;</div>
            <p>Analysis results will appear here</p>
            <p style="font-size:.82rem;margin-top:8px;color:#b0b8c4">Upload your resume, select a job, and click Analyze</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // === AUTH ===
  var PWD='925summit';
  function authed(){ return localStorage.getItem('bl_auth')==='1'; }
  function showApp(){ document.getElementById('loginScreen').style.display='none'; document.getElementById('app').style.display='block'; boot(); }
  function showLogin(){ document.getElementById('loginScreen').style.display='flex'; document.getElementById('app').style.display='none'; }
  document.getElementById('loginBtn').addEventListener('click', tryLogin);
  document.getElementById('pw').addEventListener('keydown', function(e){ if(e.key==='Enter') tryLogin(); });
  function tryLogin(){
    if(document.getElementById('pw').value===PWD){ localStorage.setItem('bl_auth','1'); showApp(); }
    else document.getElementById('loginErr').textContent='Incorrect password';
  }
  document.getElementById('logoutBtn').addEventListener('click', function(){ localStorage.removeItem('bl_auth'); showLogin(); });
  if(authed()) showApp(); else showLogin();

  // === STATE ===
  var allJobs=[], suggestions=[], accepted={}, total=0;

  // === BOOT ===
  function boot(){
    // Restore saved API key
    var savedKey = localStorage.getItem('bl_anthropic_key');
    if(savedKey) document.getElementById('apiKey').value = savedKey;

    // Load jobs
    fetch('jobs.json').then(function(r){return r.json();}).then(function(d){
      allJobs = Array.isArray(d)?d:[];
      var sel = document.getElementById('jobSelect');
      allJobs.forEach(function(j,i){
        var o = document.createElement('option');
        o.value = i;
        o.textContent = j['Job Title'] + ' - ' + j['Company'];
        sel.appendChild(o);
      });
      checkParams();
    }).catch(function(){});

    // Setup PDF.js worker
    if(typeof pdfjsLib !== 'undefined'){
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }

    // Listeners
    document.getElementById('jobSelect').addEventListener('change', function(){
      var i = parseInt(this.value);
      if(!isNaN(i) && allJobs[i]) showJob(allJobs[i]['Job Title'], allJobs[i]['Company'], allJobs[i]['Category']||'', allJobs[i]['Direct URL']||'');
      ready();
    });
    document.getElementById('resumeFile').addEventListener('change', onFile);
    document.getElementById('resumeText').addEventListener('input', ready);
    document.getElementById('jobDesc').addEventListener('input', ready);
    document.getElementById('apiKey').addEventListener('input', function(){
      localStorage.setItem('bl_anthropic_key', this.value);
      ready();
    });
    document.getElementById('analyzeBtn').addEventListener('click', analyze);
    document.getElementById('genBtn').addEventListener('click', generate);
    document.getElementById('dlTxt').addEventListener('click', dlTxt);
    document.getElementById('copyBtn').addEventListener('click', copy);
  }

  function checkParams(){
    var p = new URLSearchParams(window.location.search);
    var t=p.get('job_title'), c=p.get('company'), u=p.get('job_url'), cat=p.get('category');
    if(t && c){
      showJob(t, c, cat||'', u||'');
      for(var i=0;i<allJobs.length;i++){
        if(allJobs[i]['Job Title']===t && allJobs[i]['Company']===c){
          document.getElementById('jobSelect').value = i; break;
        }
      }
    }
  }

  function showJob(t,c,cat,url){
    document.getElementById('jobBar').style.display='block';
    document.getElementById('jTitle').textContent=t;
    document.getElementById('jCompany').textContent=c;
    document.getElementById('jMeta').textContent=cat;
    if(url && url!=='N/A'){
      var a=document.getElementById('jLink'); a.href=url; a.style.display='inline';
    }
  }

  function ready(){
    var has = document.getElementById('resumeText').value.trim().length > 50;
    var job = document.getElementById('jobDesc').value.trim().length > 20 || document.getElementById('jobSelect').value !== '';
    var key = document.getElementById('apiKey').value.trim().length > 10;
    document.getElementById('analyzeBtn').disabled = !(has && job && key);
  }

  // === FILE HANDLING ===
  function onFile(){
    var file = this.files[0];
    if(!file) return;
    var ext = file.name.split('.').pop().toLowerCase();
    var status = document.getElementById('fileStatus');

    if(ext !== 'pdf' && ext !== 'docx'){
      status.className='file-status err';
      status.textContent='Unsupported format. Please use .pdf or .docx';
      return;
    }

    status.className='file-status loading';
    status.innerHTML='<div class="spin"></div> Reading ' + esc(file.name) + '...';

    if(ext === 'pdf') readPDF(file);
    else readDOCX(file);
  }

  function readPDF(file){
    var status = document.getElementById('fileStatus');
    if(typeof pdfjsLib === 'undefined'){
      status.className='file-status err';
      status.textContent='PDF library did not load. Please paste your resume text in the box below.';
      return;
    }
    var reader = new FileReader();
    reader.onerror = function(){
      status.className='file-status err';
      status.textContent='Could not read file. Please paste your resume text below.';
    };
    reader.onload = function(){
      try{
        var data = new Uint8Array(this.result);
        pdfjsLib.getDocument({data:data}).promise.then(function(pdf){
          var n=pdf.numPages, text='', done=0;
          function next(pg){
            pdf.getPage(pg).then(function(page){
              return page.getTextContent();
            }).then(function(content){
              var lastY=null;
              content.items.forEach(function(it){
                if(lastY!==null && Math.abs(it.transform[5]-lastY)>2) text+='\n';
                text+=it.str;
                lastY=it.transform[5];
              });
              text+='\n\n';
              done++;
              status.innerHTML='<div class="spin"></div> Page '+done+' of '+n+'...';
              if(done===n) finish(text);
              else next(pg+1);
            }).catch(function(e){
              status.className='file-status err';
              status.textContent='Error on page '+pg+': '+e.message+'. Paste your resume below.';
            });
          }
          if(n>0) next(1);
          else{ status.className='file-status err'; status.textContent='PDF has no pages.'; }
        }).catch(function(e){
          status.className='file-status err';
          status.textContent='PDF parse error: '+e.message+'. Paste your resume below.';
        });
      }catch(e){
        status.className='file-status err';
        status.textContent='PDF error: '+e.message+'. Paste your resume below.';
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function readDOCX(file){
    var status = document.getElementById('fileStatus');
    if(typeof mammoth === 'undefined'){
      status.className='file-status err';
      status.textContent='DOCX library did not load. Please paste your resume text below.';
      return;
    }
    var reader = new FileReader();
    reader.onerror = function(){
      status.className='file-status err';
      status.textContent='Could not read file. Please paste your resume text below.';
    };
    reader.onload = function(){
      try{
        mammoth.extractRawText({arrayBuffer:this.result}).then(function(r){
          var t=(r.value||'').trim();
          if(!t){
            status.className='file-status err';
            status.textContent='No text found in DOCX. Paste your resume below.';
            return;
          }
          finish(t);
        }).catch(function(e){
          status.className='file-status err';
          status.textContent='DOCX error: '+e.message+'. Paste your resume below.';
        });
      }catch(e){
        status.className='file-status err';
        status.textContent='DOCX error: '+e.message+'. Paste your resume below.';
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function finish(text){
    var clean = text.replace(/\n{3,}/g,'\n\n').trim();
    var status = document.getElementById('fileStatus');
    if(!clean){
      status.className='file-status err';
      status.textContent='No text extracted (file may be image-based). Paste your resume below.';
      return;
    }
    document.getElementById('resumeText').value = clean;
    status.className='file-status ok';
    status.textContent='Extracted '+clean.split(/\s+/).length+' words from resume.';
    ready();
  }

  // === ANALYSIS ===
  function analyze(){
    var key = document.getElementById('apiKey').value.trim();
    var resume = document.getElementById('resumeText').value.trim();
    var desc = document.getElementById('jobDesc').value.trim();
    var jobCtx = '';
    var idx = parseInt(document.getElementById('jobSelect').value);
    if(!isNaN(idx) && allJobs[idx]){
      var j=allJobs[idx];
      jobCtx += 'Job Title: '+j['Job Title']+'\nCompany: '+j['Company']+'\nCategory: '+(j['Category']||'')+'\nLocation: '+(j['Location']||'')+'\n\n';
    }
    if(desc) jobCtx += 'Full Job Description:\n'+desc;
    if(!jobCtx.trim()){ showErr('Please select a job or paste a description.'); return; }

    document.getElementById('analyzeBtn').disabled=true;
    var prog=document.getElementById('prog');
    prog.classList.add('show');
    document.getElementById('progText').textContent='Analyzing your resume...';
    hideErr();

    var slow = setTimeout(function(){ document.getElementById('progText').textContent='Still analyzing... this may take a moment.'; }, 10000);

    var sysPrompt = 'You are a resume optimization expert. Analyze the provided resume against the job description and suggest specific, truthful improvements. Rules:\n' +
      '- ONLY reframe existing experience, never invent skills or experience\n' +
      '- Focus on: keyword alignment, quantifying achievements, using employer terminology, highlighting relevant aspects\n' +
      '- Organize by resume section (Summary, Skills, Work Experience, Education, Certifications)\n' +
      '- For each: provide original text, suggested revision, one sentence explaining why it helps for THIS job\n' +
      '- Reframe generic terms with role-specific terminology from the JD\n' +
      '- Maximum 12 suggestions, highest impact first\n' +
      '- Return ONLY valid JSON: {"sections":[{"section_name":"...","suggestions":[{"original":"...","suggested":"...","explanation":"..."}]}]}';

    var userMsg = 'JOB:\n\n'+jobCtx+'\n\n---\n\nRESUME:\n\n'+resume+'\n\nReturn suggestions as the specified JSON. No other text.';

    fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-api-key':key,
        'anthropic-version':'2023-06-01',
        'anthropic-dangerous-direct-browser-access':'true'
      },
      body:JSON.stringify({
        model:'claude-sonnet-4-6',
        max_tokens:4000,
        system:sysPrompt,
        messages:[{role:'user',content:userMsg}]
      })
    })
    .then(function(r){
      if(!r.ok) return r.json().then(function(e){ throw new Error(e.error&&e.error.message||'API error '+r.status); });
      return r.json();
    })
    .then(function(data){
      clearTimeout(slow);
      prog.classList.remove('show');
      document.getElementById('analyzeBtn').disabled=false;
      var txt = data.content[0].text;
      var m = txt.match(/\{[\s\S]*\}/);
      if(!m) throw new Error('Could not parse AI response');
      showSuggestions(JSON.parse(m[0]));
    })
    .catch(function(e){
      clearTimeout(slow);
      prog.classList.remove('show');
      document.getElementById('analyzeBtn').disabled=false;
      showErr('Analysis failed: '+e.message);
    });
  }

  // === SUGGESTIONS ===
  function showSuggestions(result){
    var body = document.getElementById('sugBody');
    body.innerHTML='';
    suggestions=[]; accepted={}; total=0;
    document.getElementById('emptyState').style.display='none';
    document.getElementById('resultsWrap').style.display='block';
    var si=0;
    (result.sections||[]).forEach(function(sec){
      var div=document.createElement('div');
      div.className='sug-section';
      var h=document.createElement('h3');
      h.textContent=sec.section_name;
      div.appendChild(h);
      (sec.suggestions||[]).forEach(function(s){
        var id='s'+si;
        suggestions.push({id:id,section:sec.section_name,original:s.original,suggested:s.suggested,explanation:s.explanation});
        total++;
        var c=document.createElement('div');
        c.className='sug-card'; c.id=id;
        c.innerHTML=
          '<div class="sug-lbl" style="color:#94a3b8">ORIGINAL</div>'+
          '<div class="sug-orig">'+esc(s.original)+'</div>'+
          '<div class="sug-lbl" style="color:#16a34a">SUGGESTED</div>'+
          '<div class="sug-new">'+esc(s.suggested)+'</div>'+
          '<div class="sug-why">Why: '+esc(s.explanation)+'</div>'+
          '<div class="sug-btns">'+
            '<button class="sb-accept" data-id="'+id+'">Accept</button>'+
            '<button class="sb-skip" data-id="'+id+'">Skip</button>'+
          '</div>';
        div.appendChild(c);
        si++;
      });
      body.appendChild(div);
    });
    body.querySelectorAll('.sb-accept').forEach(function(b){
      b.addEventListener('click',function(){ toggleAccept(b.dataset.id); });
    });
    body.querySelectorAll('.sb-skip').forEach(function(b){
      b.addEventListener('click',function(){ toggleSkip(b.dataset.id); });
    });
    updateCount();
    document.getElementById('dlRow').style.display='flex';
  }

  function toggleAccept(id){
    var c=document.getElementById(id);
    if(accepted[id]==='y'){
      accepted[id]=undefined; c.className='sug-card';
      c.querySelector('.sb-accept').textContent='Accept';
      c.querySelector('.sb-accept').classList.remove('on');
    } else {
      accepted[id]='y'; c.className='sug-card accepted';
      c.querySelector('.sb-accept').textContent='Accepted';
      c.querySelector('.sb-accept').classList.add('on');
      c.querySelector('.sb-skip').textContent='Skip';
    }
    updateCount();
  }

  function toggleSkip(id){
    var c=document.getElementById(id);
    if(accepted[id]==='n'){
      accepted[id]=undefined; c.className='sug-card';
      c.querySelector('.sb-skip').textContent='Skip';
    } else {
      accepted[id]='n'; c.className='sug-card skipped';
      c.querySelector('.sb-skip').textContent='Skipped';
      c.querySelector('.sb-accept').textContent='Accept';
      c.querySelector('.sb-accept').classList.remove('on');
    }
    updateCount();
  }

  function updateCount(){
    var n=0;
    for(var k in accepted) if(accepted[k]==='y') n++;
    var el=document.getElementById('sugCount');
    el.textContent=n+' of '+total+' suggestions accepted';
    el.classList.add('show');
  }

  // === GENERATE ===
  function generate(){
    var text=document.getElementById('resumeText').value;
    suggestions.forEach(function(s){
      if(accepted[s.id]==='y' && text.indexOf(s.original)!==-1){
        text=text.replace(s.original,s.suggested);
      }
    });
    window._resume=text;
    var n=0; for(var k in accepted) if(accepted[k]==='y') n++;
    alert('Resume updated with '+n+' changes. Use Download or Copy to get it.');
  }

  function dlTxt(){
    if(!window._resume){alert('Generate first.');return;}
    var b=new Blob([window._resume],{type:'text/plain'});
    var a=document.createElement('a');
    a.href=URL.createObjectURL(b);
    var t=document.getElementById('jTitle').textContent||'tailored';
    var c=document.getElementById('jCompany').textContent||'';
    a.download='Resume_'+t.replace(/[^a-zA-Z0-9]/g,'_')+'_'+c.replace(/[^a-zA-Z0-9]/g,'_')+'.txt';
    a.click(); URL.revokeObjectURL(a.href);
  }

  function copy(){
    if(!window._resume){alert('Generate first.');return;}
    navigator.clipboard.writeText(window._resume).then(function(){
      var b=document.getElementById('copyBtn');
      b.textContent='Copied!';
      setTimeout(function(){b.textContent='Copy to Clipboard';},2000);
    });
  }

  // === HELPERS ===
  function esc(s){if(!s)return '';var d=document.createElement('div');d.textContent=s;return d.innerHTML;}
  function showErr(m){var e=document.getElementById('analysisErr');e.textContent=m;e.classList.add('show');}
  function hideErr(){document.getElementById('analysisErr').classList.remove('show');}
})();
</script>
</body>
</html>
